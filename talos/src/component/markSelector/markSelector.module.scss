@use '../../styles/palette.scss' as *;
@use '../../styles/curves.scss' as *;

:root, :root[data-theme='light'] {
    --mark-bg: #{$white-1};
    --mark-text: #{$grey-1};
    --mark-active-bg: #{$mid};
    --mark-stats-text: #{$dim-1};
    --mark-active-fg: #{rgba($black-0, 1)};
    --mark-completed-bg: #{$primary-accent-2};
    --mark-progress-bg: #{rgba($primary-accent-3, 1)};
    --mark-separator: #{$grey-1};
}
:root[data-theme='dark'] {
    --mark-bg: #{$grey-1};
    --mark-text: #{$white-1};
    --mark-active-bg: #{$grey-2};
    --mark-stats-text: #{$light-1};
    --mark-active-fg: #{$white-1};
    --mark-completed-bg: #{$primary-accent-4};
    --mark-progress-bg: #{rgba($primary-accent-4, 0.8)};
    --mark-separator: #{$white-2};
}

/* Skeleton layer: participates ONLY in grid layout, occupies space and fixes collapsed height, no animation */
.markSkeleton {
    position: relative;
    width: 100%;
    /* Collapsed height */
    --mark-item-collapsed-h: 3.2rem;
    height: var(--mark-item-collapsed-h);
    margin-bottom: 0.75rem;
    overflow: visible; /* allow content layer(markItem) to overflow */
}

.markItem {
    user-select: none;
    touch-action: pan-y;
    /* Content layer: absolutely positioned within skeleton plot */
    position: absolute;
    inset: 0 auto auto 0;
    width: 100%;
    background-color: var(--mark-bg);
    color: var(--mark-text);
    border-radius: 0 2px 2px 0;
    padding: 0.25rem;
    cursor: pointer;
    box-shadow: 0 0 3px 1px rgba($black-0, 0);
    transition: box-shadow 0.2s ease, transform 0.2s ease, background-color 0.3s ease;
    will-change: box-shadow, transform, background-color;
    overflow: visible;
    display: grid;
    grid-template-columns: 0.5fr 1.5fr;
    grid-template-rows: auto auto; /* allow name row to grow when expanded */
    gap: 0 2px;
    grid-template-areas:
        'icon Name'
        'icon Num';
    &.active {
        background-color: var(--mark-active-bg);
        color: var(--mark-active-fg);
        box-shadow: 0 3px 4px rgba($black-0, 0.4);
        transition: all 0.2s ease;
        //mix-blend-mode: luminosity;
        &::after {
            clip-path: polygon(
                0 0,
                var(--progress-percentage, 0%) 0,
                var(--progress-percentage, 0%) 100%,
                0 100%
            );
        }
    }
    &.completed {
        background-color: var(--mark-completed-bg);
        box-shadow: 0 3px 6px rgba($black-0, 0.3);
    }
    &::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background-color: var(--mark-progress-bg);
        clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
        transition: clip-path 0.3s ease;
        z-index: -1;
    }
    &::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 3px;
        height: 100%;
        background-color: var(--mark-separator);
        z-index: 3;
        clip-path: polygon(0 0, 100% 0, 100% 0, 0 0);
        transition: clip-path 0.3s $standard-curve, background-color 0.35s $moderato-curve;
    }
    &.active::before {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
    }
    &:hover {
        box-shadow: 1px 3px 5px rgba($black-0, 0.2);
        transform: translateY(-1px);
    }
    /* Name layer: expanded state */
    .markNameExpanded {
        display: block;
        color: inherit;
        margin: 2px 0;
        white-space: normal;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition:
            max-height 0.5s $presto-curve,
            opacity 0.3s $presto-curve;
    }
    &[data-truncated='true']:hover .markNameExpanded {
        /* expand to measured height and max 7 lines */
        max-height: var(--expanded-height, 8.4em);
        opacity: 1;
    }
    &[data-truncated='true']:hover .markName {
        max-height: 0;
        opacity: 0;
    }
    .markName {
        transition:
            max-height 0.5s $presto-curve,
            opacity 0.3s $presto-curve;
        max-height: 1.2em; /* single line height for smooth collapse */
    }
    .markIcon {
        grid-area: icon;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        position: relative;

        --icon-feather-width: 10%;
        --icon-feather-start: 4%;
        mask-image:
            linear-gradient(
                to right,
                transparent 0%,
                transparent var(--icon-feather-start),
                black var(--icon-feather-width),
                black calc(100% - var(--icon-feather-width)),
                transparent calc(100% - var(--icon-feather-start)),
                transparent 100%
            ),
            linear-gradient(
                to bottom,
                transparent 0%,
                transparent var(--icon-feather-start),
                black var(--icon-feather-width),
                black calc(100% - var(--icon-feather-width)),
                transparent calc(100% - var(--icon-feather-start)),
                transparent 100%
            );
        mask-composite: intersect;

        img {
            max-width: 2.25rem;
            max-height: 2.25rem;
            object-fit: contain;
        }
    }
    .markName, .markNameExpanded {
        grid-area: unset;
        font-weight: 800;
        line-height: 1.2;
        font-family: 'Novecento DemiBold', 'UD_ShinGo DemiBold', sans-serif;
        color: inherit;
        font-size: 0.75rem;
        letter-spacing: -.2px;
        word-break: break-all;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    .markName {
        margin: 0;
        z-index: 2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        width: 100%;
        max-width: 100%;
    }
    .markStat {
        grid-area: Num;
        font-size: 0.8rem;
        font-family: 'Novecento Medium', sans-serif;
        color: var(--mark-stats-text);
        font-weight: 600;
        align-self: start;
        z-index: 2;
        line-height: 1;
        margin: auto 0;
    }

    /* name cell wraps the main ellipsized name and an absolute expanded panel */
    .nameCell {
        grid-area: Name;
        position: relative;
        display: block;
        min-width: 0; /* allow ellipsis to work in grid cell */
        width: 100%;
        align-self: end;
        overflow: hidden; /* allow expansion within document flow, hide overflow for smooth transition */
    }
}